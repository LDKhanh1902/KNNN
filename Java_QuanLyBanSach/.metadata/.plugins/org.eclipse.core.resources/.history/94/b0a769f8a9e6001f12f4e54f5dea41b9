package vn.DA_KNNN.View;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import org.jdatepicker.impl.*;
import org.jfree.chart.ChartFactory;
import org.jfree.chart.ChartPanel;
import org.jfree.chart.JFreeChart;
import org.jfree.chart.plot.CategoryPlot;
import org.jfree.chart.renderer.category.LineAndShapeRenderer;
import org.jfree.data.category.DefaultCategoryDataset;

import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.FileOutputStream;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Properties;

public class RevenueView extends JPanel {
    private static final long serialVersionUID = 1L;
    private JTable revenueTable;
    private DefaultTableModel revenueModel;
    private JLabel lblTotalRevenue;
    private JDatePickerImpl startDatePicker, endDatePicker;

    public RevenueView() {
        setLayout(new BorderLayout());

        // **1. Bộ lọc thời gian**
        JPanel filterPanel = new JPanel();
        filterPanel.add(new JLabel("Từ ngày:"));
        startDatePicker = createDatePicker();
        filterPanel.add(startDatePicker);
        filterPanel.add(new JLabel("Đến ngày:"));
        endDatePicker = createDatePicker();
        filterPanel.add(endDatePicker);
        JButton btnFilter = new JButton("Lọc");
        filterPanel.add(btnFilter);
        add(filterPanel, BorderLayout.NORTH);

        // **2. Bảng doanh thu**
        String[] revenueColumns = {"Tháng", "Doanh thu (VNĐ)"};
        Object[][] revenueData = {
                {"Tháng 1", 5000000},
                {"Tháng 2", 7000000},
                {"Tháng 3", 4500000},
                {"Tháng 4", 8000000},
                {"Tháng 5", 6500000},
        };
        revenueModel = new DefaultTableModel(revenueData, revenueColumns);
        revenueTable = new JTable(revenueModel);
        add(new JScrollPane(revenueTable), BorderLayout.CENTER);

        // **3. Hiển thị tổng doanh thu**
        JPanel summaryPanel = new JPanel();
        lblTotalRevenue = new JLabel("Tổng doanh thu: 0 VNĐ");
        summaryPanel.add(lblTotalRevenue);
        add(summaryPanel, BorderLayout.SOUTH);

        // **4. Biểu đồ doanh thu**
        JPanel chartPanel = new JPanel();
        chartPanel.add(createLineChartPanel());
        add(chartPanel, BorderLayout.EAST);

        // **5. Nút xuất báo cáo**
        JButton btnExport = new JButton("In báo cáo doanh thu");
        btnExport.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                exportToPDF();
            }
        });
        summaryPanel.add(btnExport);
    }

    /**
     * Tạo Date Picker
     */
    private JDatePickerImpl createDatePicker() {
        Properties properties = new Properties();
        properties.put("text.today", "Hôm nay");
        properties.put("text.month", "Tháng");
        properties.put("text.year", "Năm");

        UtilDateModel model = new UtilDateModel();
        JDatePanelImpl datePanel = new JDatePanelImpl(model, properties);
        return new JDatePickerImpl(datePanel, new DateLabelFormatter());
    }

    /**
     * Biểu đồ doanh thu theo ngày
     */
    private JPanel createLineChartPanel() {
        DefaultCategoryDataset dataset = new DefaultCategoryDataset();
        dataset.addValue(10, "Doanh thu", "01-02");
        dataset.addValue(20, "Doanh thu", "02-02");
        dataset.addValue(15, "Doanh thu", "03-02");
        dataset.addValue(25, "Doanh thu", "04-02");

        JFreeChart chart = ChartFactory.createLineChart(
                "Doanh thu theo ngày",
                "Ngày",
                "Doanh thu (VNĐ)",
                dataset
        );

        CategoryPlot plot = (CategoryPlot) chart.getPlot();
        LineAndShapeRenderer renderer = new LineAndShapeRenderer();
        renderer.setSeriesPaint(0, Color.BLUE);
        renderer.setSeriesShapesVisible(0, true);
        plot.setRenderer(renderer);

        return new ChartPanel(chart);
    }

    /**
     * Xuất báo cáo doanh thu ra file PDF
     */
    private void exportToPDF() {

    }

    /**
     * Format ngày cho JDatePicker
     */
    private class DateLabelFormatter extends JFormattedTextField.AbstractFormatter {
        private SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");

        @Override
        public Object stringToValue(String text) throws java.text.ParseException {
            return dateFormat.parseObject(text);
        }

        @Override
        public String valueToString(Object value) {
            if (value != null) {
                Date date = (Date) value;
                return dateFormat.format(date);
            }
            return "";
        }
    }

    public static void main(String[] args) {
        JFrame frame = new JFrame("Thống kê doanh thu");
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        frame.setSize(800, 600);
        frame.add(new RevenueView());
        frame.setLocationRelativeTo(null);
        frame.setVisible(true);
    }
}
