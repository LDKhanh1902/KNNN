package vn.DA_KNNN.View;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;

public class SaleView extends JPanel {
    private static final long serialVersionUID = 1L;
    private JTextField searchField;
    private JTable bookTable, cartTable;
    private DefaultTableModel bookModel, cartModel;
    private JLabel totalPriceLabel;

    public SaleView() {
        setLayout(new BorderLayout(10, 10));

        // **ðŸ”Ž Thanh TÃ¬m Kiáº¿m**
        JPanel searchPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 10, 10));
        searchPanel.add(new JLabel("ðŸ”Ž TÃ¬m kiáº¿m sÃ¡ch:"));
        searchField = new JTextField(20);
        searchPanel.add(searchField);
        JButton searchButton = new JButton("TÃ¬m");
        searchPanel.add(searchButton);
        add(searchPanel, BorderLayout.NORTH);

        // **ðŸ“š Danh sÃ¡ch SÃ¡ch (Báº£ng)**
        String[] bookColumns = {"TÃªn sÃ¡ch", "GiÃ¡ (VNÄ)"};
        bookModel = new DefaultTableModel(bookColumns, 0);
        bookTable = new JTable(bookModel);
        JScrollPane bookScrollPane = new JScrollPane(bookTable);
        add(bookScrollPane, BorderLayout.WEST);

        // **ðŸ›’ Giá» HÃ ng (Báº£ng)**
        String[] cartColumns = {"TÃªn sÃ¡ch", "GiÃ¡ (VNÄ)", "Sá»‘ lÆ°á»£ng", "Tá»•ng giÃ¡", "XÃ³a"};
        cartModel = new DefaultTableModel(cartColumns, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return column == 2; // Chá»‰ cho phÃ©p chá»‰nh sá»­a sá»‘ lÆ°á»£ng
            }
        };
        cartTable = new JTable(cartModel);
        JScrollPane cartScrollPane = new JScrollPane(cartTable);
        add(cartScrollPane, BorderLayout.CENTER);

        // **ðŸ’° Tá»•ng Tiá»n & NÃºt Thanh ToÃ¡n**
        JPanel bottomPanel = new JPanel(new BorderLayout());
        JPanel totalPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT, 10, 10));
        totalPriceLabel = new JLabel("ðŸ’° Tá»•ng tiá»n: 0 VNÄ");
        totalPanel.add(totalPriceLabel);
        bottomPanel.add(totalPanel, BorderLayout.NORTH);

        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT, 10, 10));
        JButton printInvoiceButton = new JButton("ðŸ–¨ï¸ Xuáº¥t HÃ³a ÄÆ¡n");
        JButton payButton = new JButton("ðŸ¦ Thanh ToÃ¡n");
        JButton refreshButton = new JButton("ðŸ”„ LÃ m Má»›i");
        buttonPanel.add(printInvoiceButton);
        buttonPanel.add(payButton);
        buttonPanel.add(refreshButton);
        bottomPanel.add(buttonPanel, BorderLayout.SOUTH);

        add(bottomPanel, BorderLayout.SOUTH);

        // **ðŸ“‘ ThÃªm Dá»¯ Liá»‡u SÃ¡ch Máº«u**
        addSampleBooks();

        // **ðŸŽ¯ Xá»­ lÃ½ sá»± kiá»‡n**
        searchButton.addActionListener(e -> searchBook());
        payButton.addActionListener(e -> processPayment());
        printInvoiceButton.addActionListener(e -> printInvoice());
        refreshButton.addActionListener(e -> resetCart());
        cartModel.addTableModelListener(e -> updateTotalPrice());

        // **ðŸ›’ Xá»­ lÃ½ khi click "ThÃªm vÃ o giá»"**
        bookTable.getSelectionModel().addListSelectionListener(e -> {
            if (!e.getValueIsAdjusting()) {
                int selectedRow = bookTable.getSelectedRow();
                if (selectedRow != -1) {
                    String bookName = (String) bookModel.getValueAt(selectedRow, 0);
                    int price = (int) bookModel.getValueAt(selectedRow, 1);
                    addToCart(bookName, price, 1);
                }
            }
        });
    }

    /**
     * ðŸ“Œ ThÃªm dá»¯ liá»‡u sÃ¡ch máº«u
     */
    private void addSampleBooks() {
        Object[][] books = {
            {"Harry Potter", 120000},
            {"Doraemon", 80000},
            {"Sherlock Holmes", 100000},
            {"BÃ­ áº¨n VÅ© Trá»¥", 150000},
            {"Láº­p TrÃ¬nh Java", 180000}
        };
        for (Object[] book : books) {
            bookModel.addRow(book);
        }
    }

    /**
     * ðŸ“Œ TÃ¬m kiáº¿m sÃ¡ch
     */
    private void searchBook() {
        String keyword = searchField.getText().trim();
        if (keyword.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Vui lÃ²ng nháº­p tá»« khÃ³a tÃ¬m kiáº¿m!", "Lá»—i", JOptionPane.ERROR_MESSAGE);
            return;
        }

        boolean found = false;
        for (int i = 0; i < bookModel.getRowCount(); i++) {
            String bookName = (String) bookModel.getValueAt(i, 0);
            if (bookName.equalsIgnoreCase(keyword)) {
                found = true;
                addToCart(bookName, (int) bookModel.getValueAt(i, 1), 1);
                break;
            }
        }

        if (!found) {
            JOptionPane.showMessageDialog(this, "KhÃ´ng tÃ¬m tháº¥y sÃ¡ch!", "ThÃ´ng bÃ¡o", JOptionPane.INFORMATION_MESSAGE);
        }
    }

    /**
     * ðŸ“Œ ThÃªm sÃ¡ch vÃ o giá» hÃ ng
     */
    private void addToCart(String bookName, int price, int quantity) {
        for (int i = 0; i < cartModel.getRowCount(); i++) {
            if (cartModel.getValueAt(i, 0).equals(bookName)) {
                int oldQuantity = (int) cartModel.getValueAt(i, 2);
                cartModel.setValueAt(oldQuantity + quantity, i, 2);
                updateTotalPrice();
                return;
            }
        }
        cartModel.addRow(new Object[]{bookName, price, quantity, price * quantity, "âŒ"});
        updateTotalPrice();
    }

    /**
     * ðŸ“Œ Cáº­p nháº­t tá»•ng tiá»n
     */
    private void updateTotalPrice() {
        int total = 0;
        for (int i = 0; i < cartModel.getRowCount(); i++) {
            int price = (int) cartModel.getValueAt(i, 1);
            int quantity = (int) cartModel.getValueAt(i, 2);
            cartModel.setValueAt(price * quantity, i, 3);
            total += price * quantity;
        }
        totalPriceLabel.setText("ðŸ’° Tá»•ng tiá»n: " + total + " VNÄ");
    }

    /**
     * ðŸ“Œ Xá»­ lÃ½ thanh toÃ¡n
     */
    private void processPayment() {
        if (cartModel.getRowCount() == 0) {
            JOptionPane.showMessageDialog(this, "Giá» hÃ ng trá»‘ng!", "Lá»—i", JOptionPane.ERROR_MESSAGE);
            return;
        }

        JOptionPane.showMessageDialog(this, "Thanh toÃ¡n thÃ nh cÃ´ng!", "ThÃ´ng bÃ¡o", JOptionPane.INFORMATION_MESSAGE);
        cartModel.setRowCount(0);
        updateTotalPrice();
    }

    /**
     * ðŸ“Œ Xuáº¥t hÃ³a Ä‘Æ¡n (chá»‰ hiá»ƒn thá»‹ thÃ´ng bÃ¡o)
     */
    private void printInvoice() {
        JOptionPane.showMessageDialog(this, "HÃ³a Ä‘Æ¡n Ä‘Ã£ Ä‘Æ°á»£c in!", "ThÃ´ng bÃ¡o", JOptionPane.INFORMATION_MESSAGE);
    }

    /**
     * ðŸ“Œ LÃ m má»›i giá» hÃ ng
     */
    private void resetCart() {
        cartModel.setRowCount(0);
        updateTotalPrice();
    }

    /**
     * ðŸ“Œ Cháº¡y form bÃ¡n sÃ¡ch (HÃ m Main)
     */
    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> {
            JFrame frame = new JFrame("Há»‡ thá»‘ng BÃ¡n SÃ¡ch");
            frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
            frame.setSize(900, 600);
            frame.add(new SaleView());
            frame.setLocationRelativeTo(null);
            frame.setVisible(true);
        });
    }
}
